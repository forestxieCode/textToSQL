name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize] # 当新建 PR 或有新提交时触发

jobs:
  ai_review:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # 必须权限：允许 Actions 写评论
      
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: pip install requests

      - name: Run AI Reviewer
        env:
          # 以下变量会自动从 Secrets 或 GitHub 上下文中注入
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub 自动生成的，无需手动设置
          DIFY_API_KEY: ${{ secrets.DIFY_API_KEY }} # 需要你去设置
          DIFY_API_URL: "https://api.dify.ai/v1"    # 如果是云端版用这个
          
          # 从 Event Context 中获取信息
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: python .github/scripts/ai_reviewer.py
