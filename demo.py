"""
Demo script showing the LangGraph text-to-SQL agent workflow.

This demonstrates the agent's functionality without requiring an OpenAI API key.
"""
from database import db_manager
from formatter import OutputFormatter
from constants import OUTPUT_SEPARATOR, OUTPUT_SUBSEPARATOR


def demo_agent_workflow():
    """Demonstrate the complete agent workflow."""
    print(OUTPUT_SEPARATOR)
    print("ğŸ¤– LangGraph Text-to-SQL Agent Demo")
    print(OUTPUT_SEPARATOR)
    
    # Step 1: Get database schema
    print("\næ­¥éª¤ 1: è·å–æ•°æ®åº“ç»“æ„ / Step 1: Get database schema")
    print(OUTPUT_SUBSEPARATOR)
    schema = db_manager.get_schema()
    print(schema)
    
    # Step 2: Demonstrate SQL generation (simulated)
    print("\n\næ­¥éª¤ 2: ç”Ÿæˆ SQL æŸ¥è¯¢ / Step 2: Generate SQL queries")
    print(OUTPUT_SUBSEPARATOR)
    
    # Example queries that would be generated by the LLM
    example_queries = [
        {
            "question": "æ˜¾ç¤ºæ‰€æœ‰ç”¨æˆ· / Show all users",
            "sql": "SELECT * FROM users"
        },
        {
            "question": "æ‰¾å‡ºè´­ä¹°äº†ç¬”è®°æœ¬ç”µè„‘çš„ç”¨æˆ· / Find users who bought laptops",
            "sql": """SELECT DISTINCT u.name, u.email
FROM users u
JOIN orders o ON u.id = o.user_id
JOIN products p ON o.product_id = p.id
WHERE p.name LIKE '%ç¬”è®°æœ¬ç”µè„‘%'"""
        },
        {
            "question": "ç»Ÿè®¡æ¯ä¸ªäº§å“çš„æ€»é”€é‡ / Count total sales for each product",
            "sql": """SELECT p.name, SUM(o.quantity) as total_sales
FROM products p
JOIN orders o ON p.id = o.product_id
GROUP BY p.name
ORDER BY total_sales DESC"""
        },
        {
            "question": "æ˜¾ç¤ºä»·æ ¼æœ€é«˜çš„3ä¸ªäº§å“ / Show top 3 most expensive products",
            "sql": "SELECT name, price, category FROM products ORDER BY price DESC LIMIT 3"
        }
    ]
    
    # Step 3: Execute queries and show results
    for i, example in enumerate(example_queries, 1):
        print(f"\n{OUTPUT_SEPARATOR}")
        print(f"ç¤ºä¾‹ {i} / Example {i}")
        print(OUTPUT_SEPARATOR)
        print(f"\nç”¨æˆ·é—®é¢˜ / User Question:")
        print(f"  {example['question']}")
        print(f"\nç”Ÿæˆçš„ SQL / Generated SQL:")
        print(f"  {example['sql']}")
        print(f"\næŸ¥è¯¢ç»“æœ / Query Results:")
        print(OUTPUT_SUBSEPARATOR)
        
        # Execute the query
        try:
            results = db_manager.execute_query(example['sql'])
            formatted_output = OutputFormatter.format_table(results)
            print(formatted_output)
        except Exception as e:
            print(f"âŒ Error: {e}")
    
    print(f"\n{OUTPUT_SEPARATOR}")
    print("âœ… Demo completed successfully!")
    print(OUTPUT_SEPARATOR)
    print("\nğŸ“ æ³¨æ„ / Note:")
    print("  è¦ä½¿ç”¨å®Œæ•´çš„æ™ºèƒ½ä½“åŠŸèƒ½ï¼Œéœ€è¦é…ç½® OPENAI_API_KEY ç¯å¢ƒå˜é‡")
    print("  To use the full agent functionality, configure the OPENAI_API_KEY environment variable")
    print("\n  ç„¶åè¿è¡Œ / Then run:")
    print("    python cli.py")
    print(OUTPUT_SEPARATOR)


if __name__ == "__main__":
    demo_agent_workflow()
